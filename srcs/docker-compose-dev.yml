services:
  # ──────────────────────────────────────────────────────────
  auth_service:
    container_name: auth_service
    restart: "no"
    env_file:
      - ./.env
    environment:
      - PGHOST=database
      - PGUSER=${DB_USER}
      - PGPASSWORD=${DB_PASS}
      - PGDATABASE=${DB_NAME}
      - GOOGLE_CLIENT_ID=428358411017-tpnb2gagmtg8vve9hlahkh962d7h76hf.apps.googleusercontent.com
      - GOOGLE_CLIENT_SECRET=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
      # ⇩ Quand tu passeras par Nginx, remplace localhost:3000 par ton domaine/port proxy
      # Read CALLBACK_URL from .env for HTTPS callback over the proxy
      - CALLBACK_URL=${CALLBACK_URL}
      - COOKIE_SECRET=fdaf682f5ec7571eb3dc2d08655cae7f6b7c026d8218088fc13fa2e546a084b4
      - API_CREDENTIAL=83294bb5c629d7e456e9bbed76693581304b977fce80a57a6cccf37c470a41c0
      - JWT_SECRET=e4l+2nJoNiabS7MpIYdmzHTfs0ju5iy3xgg1o48+149NeJ4PXHzoIQ21THvoTgUGXbhF6mJYSJyU0EzEEcXiuw==
      - PGPORT=5432
      - NODE_ENV=dev
      - PORT=3000
      # Vault config pour récupération sécurisée des secrets
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=root

    build:
      context: ./backend/auth_service
      dockerfile: Dockerfile
      args:
        - NODE_ENV=dev
    expose:
      - "3000"              # ▶ visible uniquement dans le réseau Docker
    ports:
      - "3000:3000"        # ▶ mappe le port interne pour tests locaux via localhost
    depends_on:
      - user_service
      - vault_service        # Vault doit démarrer avant auth_service
    networks:
      - router

  # ──────────────────────────────────────────────────────────
  vault_service:
    container_name: vault
    build:
      context: ./backend/vault_service
    ports:
      - "8200:8200"          # port exposé pour accéder à Vault
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "root"       # token root dev (jamais en prod)
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "root"
    networks:
      - router

  # ──────────────────────────────────────────────────────────
  game_service:
    container_name: game_service
    restart: "no"
    environment:
      - PGHOST=database
      - PGUSER=${DB_USER}
      - PGPASSWORD=${DB_PASS}
      - PGDATABASE=${DB_NAME}
      - PGPORT=5432
      - NODE_ENV=dev
      # Ensure Fastify listens on 3001 to match Dockerfile
      - PORT=3001
    build:
      context: ./backend/game_service
      dockerfile: Dockerfile
      args:
        - NODE_ENV=dev
    ports:
      - "3001:3000"
    networks:
      - router

  # ──────────────────────────────────────────────────────────
  user_service:
    container_name: user_service
    restart: "no"
    env_file:
      - ./.env
    environment:
      - PGHOST=database
      - PGUSER=${DB_USER}
      - PGPASSWORD=${DB_PASS}
      - PGDATABASE=${DB_NAME}
      - PGPORT=5432
      - NODE_ENV=dev
      - API_CREDENTIAL=83294bb5c629d7e456e9bbed76693581304b977fce80a57a6cccf37c470a41c0
      - PORT=3001
    build:
      context: ./backend/user_service
      dockerfile: Dockerfile
      args:
        - NODE_ENV=dev
    ports:
      - "3002:3000"
    networks:
      - router
  # ──────────────────────────────────────────────────────────
  tournament_service:
    container_name: tournament_service
    restart: "no"
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASS}@database:5432/${DB_NAME}
    build:
      context: ./backend/tournament_service
      dockerfile: Dockerfile
      args:
        - NODE_ENV=dev
    expose:
      - "3000"
    ports:
      - "3003:3000"
    networks:
      - router

  # ──────────────────────────────────────────────────────────
  database:
    container_name: database_service
    build: ./backend/database/
    volumes:
      - database:/db
    tty: true
    env_file:
      - ./.env
    environment:
      # - PGHOST=database -> pour autres containers
      - PGUSER=${DB_USER}
      - PGPASSWORD=${DB_PASS}
      - PGDATABASE=${DB_NAME}
      - PGPORT=5432
      - POSTGRES_USER=${DB_SUPERUSER}
      - POSTGRES_PASSWORD=${DB_SUPERPASS}
      - POSTGRES_DB=${DB_NAME}
      - PGDATA=/db
      - TEST=${TEST_DB:-}
      # - POSTGRES_HOST_AUTH_METHOD=trust
    expose:
      - "5432"
    networks:
      - router

# TODO remove -> pour tests brackets
    # ports:
    #   - "5432:5432"


  # ──────────────────────────────────────────────────────────
  frontend:
    container_name: frontend
    restart: "no"
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:        # ← ajoute si PORT n’est pas déjà fixé côté Vite
      - PORT=4000
    expose:
      - "4000"          # ← reste 4000
    networks:
      - router

  # ──────────────────────────────────────────────────────────
  nginx:
    container_name: nginx
    restart: "no"
    build:
      context: ./nginx
      dockerfile: Dockerfile
    depends_on:
      - auth_service
      - game_service
      - user_service
      - frontend
    ports:
      - "4443:443"          # 🔐 HTTPS vers l’hôte
      - "8080:80"            # HTTP for development
    networks:
      - router

# ──────────────────────────────────────────────────────────────
volumes:
  database:

networks:
  router:
    driver: bridge
