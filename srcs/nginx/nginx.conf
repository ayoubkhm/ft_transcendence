user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/proxy_params;

    # Upstream services
    upstream auth_service {
        server auth_service:3000;
    }
    upstream game_service {
        # Game service listens on port 3001 inside the container
        server game_service:3001;
    }
    upstream user_service {
        # User service port aligned with PORT env (default 3001)
        server user_service:3001;
    }
    upstream frontend {
        server frontend:4000;
    }

    server {
        listen 80;
        listen 443 ssl;
        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;

        # Auth service
        location /api/auth/ {
            proxy_pass http://auth_service;
        }

        # Game service API (accept both /api/game and deeper paths)
        location /api/game {
            proxy_pass http://game_service;
        }

        # User service API
        location /api/user/ {
            proxy_pass http://user_service;
        }

        # Game service metrics
        location /metrics {
            proxy_pass http://game_service;
        }

        # Frontend SPA
        location / {
            proxy_pass http://frontend;
        }
    }
}
