(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const d of n)if(d.type==="childList")for(const u of d.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function t(n){const d={};return n.integrity&&(d.integrity=n.integrity),n.referrerPolicy&&(d.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?d.credentials="include":n.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function o(n){if(n.ep)return;n.ep=!0;const d=t(n);fetch(n.href,d)}})();const g=800,L=450,te=10,v=6,p=v*4,ne={fake:"./fake.png",speedUp:"./speed.png",shield:"./shield.png",bigger:"./bigger.png",invert:"./invert.png"},C={};function oe(e,s){return new Promise((t,o)=>{const n=new Image;n.src=s,n.onload=()=>{C[e]=n,t()},n.onerror=d=>{console.error(`❌ Erreur de chargement de l'image "${e}" depuis "${s}"`,d),o(new Error(`Impossible de charger l'image "${e}"`))}})}const O=document.getElementById("login-btn"),D=document.getElementById("play-ai-btn"),M=document.getElementById("play-pvp-btn"),T=document.getElementById("play-tourn-btn"),c=document.getElementById("ai-difficulty"),l=document.getElementById("game-canvas"),A=document.getElementById("hero"),h=document.getElementById("game-result");if(!O||!D||!M||!T||!c||!l||!A||!h)throw document.getElementById("app").innerHTML='<div class="text-red-500 p-4">Missing required DOM elements</div>',new Error("Missing DOM");const a=document.getElementById("login-modal"),G=document.getElementById("login-modal-form"),j=document.getElementById("login-modal-close"),F=document.getElementById("login-email"),N=document.getElementById("login-password"),_=document.getElementById("google-login-btn"),q=document.getElementById("guest-login-btn");if(!a||!G||!j||!F||!N||!_||!q)throw new Error("Missing login modal elements");l.width=g;l.height=L;const i=l.getContext("2d");let y="",B="",H="",w=null,f;function se(e){var s;!i||!l||(i.clearRect(0,0,g,L),i.fillStyle="white",i.beginPath(),i.arc(e.ball.x,e.ball.y,v,0,Math.PI*2),i.fill(),Array.isArray(e.bonusBalls)&&e.bonusBalls.forEach(t=>{const o=C[t.type];o!=null&&o.complete&&i.drawImage(o,t.x-p,t.y-p,p*2,p*2)}),e.players.forEach(t=>{const o=t.side==="left"?0:g-te;t.power.includes("s")&&(i.fillStyle="gold",i.fillRect(o,0,t.paddle.w,L)),i.fillStyle="white";let n=t.power.length-1;for(;n>=0&&(t.power[n]==="s"||t.power[n]==="f");)n--;t.power[n]==="i"?i.fillStyle="purple":t.power[n]==="v"?i.fillStyle="blue":t.power[n]==="b"&&(i.fillStyle="red"),i.fillRect(o,t.paddle.y,t.paddle.w,t.paddle.h)}),(s=e.phantomBalls)==null||s.forEach(t=>{i.fillStyle="white",i.beginPath(),i.arc(t.x,t.y,v,0,Math.PI*2),i.fill()}),i.fillStyle="white",i.font="20px sans-serif",i.fillText(e.players[0].score,g/4,20),i.fillText(e.players[1].score,g*3/4,20))}function b(e){!y||!B||e===w||(w=e,fetch(`/api/game/${y}/input`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerId:B,type:e,ts:Date.now(),token:H})}).catch(console.error))}function ie(e){e.key==="ArrowUp"&&b("move_up"),e.key==="ArrowDown"&&b("move_down")}function le(e){(e.key==="ArrowUp"||e.key==="ArrowDown")&&b("stop")}const de=16;async function $(){try{const e=await fetch(`/api/game/${y}/state`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const s=await e.json();se(s),s.isGameOver&&f&&(clearInterval(f),f=void 0,w=null,document.fullscreenElement&&document.exitFullscreen().catch(()=>{}),h.classList.remove("hidden"),h.textContent=`Game Over — winner: ${s.winner}`,A.classList.remove("hidden"),l.classList.add("hidden"),k(!1))}catch(e){console.error("[fetchAndDraw]",e)}}async function x(e,s){await Promise.all(Object.entries(ne).map(([t,o])=>oe(t,o))),k(!0),A.classList.add("hidden"),h.classList.add("hidden"),l.classList.remove("hidden"),l.focus(),w=null;try{const n=await(await fetch("/api/game",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:e,difficulty:s})})).json();y=n.gameId,B=n.playerId,H=n.token,await $(),f=window.setInterval($,de),window.addEventListener("keydown",ie),window.addEventListener("keyup",le)}catch(t){console.error("[startGame]",t),k(!1)}}function k(e){D.disabled=e,M.disabled=e,T.disabled=e,O.disabled=e}O.addEventListener("click",e=>{e.preventDefault(),a.classList.remove("hidden")});j.addEventListener("click",e=>{e.preventDefault(),a.classList.add("hidden")});G.addEventListener("submit",async e=>{e.preventDefault();const s=F.value,t=N.value;try{(await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,password:t})})).ok?(localStorage.setItem("loggedIn","true"),window.location.reload()):alert("Login failed")}catch(o){console.error(o),alert("Login error")}});_.addEventListener("click",e=>{e.preventDefault(),window.location.href="/api/auth/login/google"});q.addEventListener("click",e=>{e.preventDefault(),console.warn("Guest login not implemented"),localStorage.setItem("loggedIn","true"),localStorage.setItem("username","Guest"),I()});document.addEventListener("keydown",e=>{e.key==="Escape"&&!a.classList.contains("hidden")&&a.classList.add("hidden")});a.addEventListener("click",e=>{e.target===a&&a.classList.add("hidden")});const R=document.getElementById("signup-btn"),r=document.getElementById("signup-modal"),U=document.getElementById("signup-modal-form"),J=document.getElementById("signup-modal-close"),K=document.getElementById("signup-cancel-btn"),V=document.getElementById("signup-email"),W=document.getElementById("signup-name"),E=document.getElementById("signup-password"),z=document.getElementById("signup-pass-feedback"),Q=document.getElementById("signup-confirm");if(!R||!r||!U||!J||!K||!V||!W||!E||!z||!Q)throw new Error("Missing signup modal elements");E.addEventListener("input",()=>{const e=E.value,s=e.length>=8,t=/\d/.test(e),o=/[!@#$%^&*]/.test(e);z.textContent=`Length: ${e.length} (${s?"✓":"✘"}), Digit: ${t?"✓":"✘"}, Special: ${o?"✓":"✘"}`});const S=document.getElementById("auth-user"),P=document.getElementById("auth-guest"),X=document.getElementById("logout-btn"),Y=document.getElementById("user-greeting");if(!S||!P||!X||!Y)throw new Error("Missing auth containers");function I(){localStorage.getItem("loggedIn")==="true"?(S.classList.remove("hidden"),P.classList.add("hidden"),Y.textContent=localStorage.getItem("username")||"Player"):(S.classList.add("hidden"),P.classList.remove("hidden"))}X.addEventListener("click",e=>{e.preventDefault(),localStorage.removeItem("loggedIn"),localStorage.removeItem("username"),I()});I();R.addEventListener("click",e=>{e.preventDefault(),r.classList.remove("hidden")});J.addEventListener("click",e=>{e.preventDefault(),r.classList.add("hidden")});K.addEventListener("click",e=>{e.preventDefault(),r.classList.add("hidden")});document.addEventListener("keydown",e=>{e.key==="Escape"&&r&&!r.classList.contains("hidden")&&r.classList.add("hidden")});r.addEventListener("click",e=>{e.target===r&&r.classList.add("hidden")});U.addEventListener("submit",async e=>{e.preventDefault();const s=V.value,t=W.value,o=E.value,n=Q.value,d=o.length>=8,u=/\d/.test(o),Z=/[!@#$%^&*]/.test(o);if(!d||!u||!Z){alert("Password must be at least 8 characters and include a number and special character.");return}if(o!==n){alert("Passwords do not match");return}try{const m=await fetch("/api/auth/signup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,name:t,password:o})}),ee=await m.json();m.ok?(localStorage.setItem("loggedIn","true"),localStorage.setItem("username",t),I(),r.classList.add("hidden")):alert(ee.error||"Sign up failed")}catch(m){console.error("Signup error:",m),alert("Sign up error")}});D.addEventListener("click",()=>{var s;if(c.classList.toggle("hidden"),!c.classList.contains("hidden"))return;const e=c.value;(s=l.requestFullscreen)==null||s.call(l).catch(()=>{}),x("ai",e)});M.addEventListener("click",()=>{var e;c.classList.add("hidden"),(e=l.requestFullscreen)==null||e.call(l).catch(()=>{}),x("pvp")});T.addEventListener("click",()=>{var e;c.classList.add("hidden"),(e=l.requestFullscreen)==null||e.call(l).catch(()=>{}),x("tournament")});
