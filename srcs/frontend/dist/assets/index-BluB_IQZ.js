(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function t(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(n){if(n.ep)return;n.ep=!0;const l=t(n);fetch(n.href,l)}})();const m=800,S=450,ie=10,k=6,p=k*4,le={fake:"./fake.png",speedUp:"./speed.png",shield:"./shield.png",bigger:"./bigger.png",invert:"./invert.png"},_={};function de(e,s){return new Promise((t,o)=>{const n=new Image;n.src=s,n.onload=()=>{_[e]=n,t()},n.onerror=l=>{console.error(`❌ Erreur de chargement de l'image "${e}" depuis "${s}"`,l),o(new Error(`Impossible de charger l'image "${e}"`))}})}const T=document.getElementById("login-btn"),x=document.getElementById("play-ai-btn"),C=document.getElementById("play-pvp-btn"),A=document.getElementById("play-tourn-btn"),g=document.getElementById("ai-difficulty"),q=document.getElementById("custom-toggle"),d=document.getElementById("game-canvas"),$=document.getElementById("hero"),w=document.getElementById("game-result");if(!T||!x||!C||!A||!g||!q||!d||!$||!w)throw document.getElementById("app").innerHTML='<div class="text-red-500 p-4">Missing required DOM elements</div>',new Error("Missing DOM");const a=document.getElementById("login-modal"),H=document.getElementById("login-modal-form"),R=document.getElementById("login-modal-close"),U=document.getElementById("login-email"),J=document.getElementById("login-password"),K=document.getElementById("google-login-btn"),V=document.getElementById("guest-login-btn");if(!a||!H||!R||!U||!J||!K||!V)throw new Error("Missing login modal elements");d.width=m;d.height=S;const i=d.getContext("2d");let I="",b="",W="",E=null,h,F,y;function re(e){var s;!i||!d||(i.clearRect(0,0,m,S),i.fillStyle="white",i.beginPath(),i.arc(e.ball.x,e.ball.y,k,0,Math.PI*2),i.fill(),Array.isArray(e.bonusBalls)&&e.bonusBalls.forEach(t=>{const o=_[t.type];o!=null&&o.complete&&i.drawImage(o,t.x-p,t.y-p,p*2,p*2)}),e.players.forEach(t=>{const o=t.side==="left"?0:m-ie;t.power.includes("s")&&(i.fillStyle="gold",i.fillRect(o,0,t.paddle.w,S)),i.fillStyle="white";let n=t.power.length-1;for(;n>=0&&(t.power[n]==="s"||t.power[n]==="f");)n--;t.power[n]==="i"?i.fillStyle="purple":t.power[n]==="v"?i.fillStyle="blue":t.power[n]==="b"&&(i.fillStyle="red"),i.fillRect(o,t.paddle.y,t.paddle.w,t.paddle.h)}),(s=e.phantomBalls)==null||s.forEach(t=>{i.fillStyle="white",i.beginPath(),i.arc(t.x,t.y,k,0,Math.PI*2),i.fill()}),i.fillStyle="white",i.font="20px sans-serif",i.fillText(e.players[0].score,m/4,20),i.fillText(e.players[1].score,m*3/4,20))}function P(e){!I||!b||e===E||(E=e,fetch(`/api/game/${I}/input`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerId:b,type:e,ts:Date.now(),token:W})}).catch(console.error))}function ae(e){e.key==="ArrowUp"&&P("move_up"),e.key==="ArrowDown"&&P("move_down")}function ce(e){(e.key==="ArrowUp"||e.key==="ArrowDown")&&P("stop")}const ue=16;async function N(){try{const e=await fetch(`/api/game/${I}/state`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const s=await e.json();if(re(s),s.isGameOver&&h){clearInterval(h),h=void 0,E=null,document.fullscreenElement&&document.exitFullscreen().catch(()=>{}),w.classList.remove("hidden"),w.textContent=`Game Over — winner: ${s.winner}`,$.classList.remove("hidden"),d.classList.add("hidden"),O(!1),y&&(clearInterval(y),y=void 0);const t=document.getElementById("game-timer");t&&t.classList.add("hidden")}}catch(e){console.error("[fetchAndDraw]",e)}}async function G(e,s){await Promise.all(Object.entries(le).map(([t,o])=>de(t,o))),O(!0),$.classList.add("hidden"),w.classList.add("hidden"),d.classList.remove("hidden"),d.focus(),E=null;try{const t={mode:e,difficulty:s,isCustomOn:q.checked},n=await(await fetch("/api/game",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();I=n.gameId,b=n.playerId,W=n.token,await N(),h=window.setInterval(N,ue),F=Date.now();const l=document.getElementById("game-timer");l&&(l.classList.remove("hidden"),l.textContent="00:00"),y=window.setInterval(()=>{const c=Date.now()-F,f=Math.floor(c/1e3),u=Math.floor(f/60).toString().padStart(2,"0"),B=(f%60).toString().padStart(2,"0");l&&(l.textContent=`${u}:${B}`)},1e3),window.addEventListener("keydown",ae),window.addEventListener("keyup",ce)}catch(t){console.error("[startGame]",t),O(!1)}}function O(e){x.disabled=e,C.disabled=e,A.disabled=e,T.disabled=e}function j(e){const s=document.getElementById("start-countdown"),t=document.getElementById("countdown-num");if(!s||!t){e();return}let o=5;t.textContent=o.toString(),s.classList.remove("hidden");const n=window.setInterval(()=>{o-=1,o<=0?(clearInterval(n),s.classList.add("hidden"),e()):t.textContent=o.toString()},1e3)}T.addEventListener("click",e=>{e.preventDefault(),a.classList.remove("hidden")});R.addEventListener("click",e=>{e.preventDefault(),a.classList.add("hidden")});H.addEventListener("submit",async e=>{e.preventDefault();const s=U.value,t=J.value;try{(await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,password:t})})).ok?(localStorage.setItem("loggedIn","true"),window.location.reload()):alert("Login failed")}catch(o){console.error(o),alert("Login error")}});K.addEventListener("click",e=>{e.preventDefault(),window.location.href="/api/auth/login/google"});V.addEventListener("click",e=>{e.preventDefault(),console.warn("Guest login not implemented"),localStorage.setItem("loggedIn","true"),localStorage.setItem("username","Guest"),L()});document.addEventListener("keydown",e=>{e.key==="Escape"&&!a.classList.contains("hidden")&&a.classList.add("hidden")});a.addEventListener("click",e=>{e.target===a&&a.classList.add("hidden")});const z=document.getElementById("signup-btn"),r=document.getElementById("signup-modal"),Q=document.getElementById("signup-modal-form"),X=document.getElementById("signup-modal-close"),Y=document.getElementById("signup-cancel-btn"),Z=document.getElementById("signup-email"),ee=document.getElementById("signup-name"),v=document.getElementById("signup-password"),te=document.getElementById("signup-pass-feedback"),ne=document.getElementById("signup-confirm");if(!z||!r||!Q||!X||!Y||!Z||!ee||!v||!te||!ne)throw new Error("Missing signup modal elements");v.addEventListener("input",()=>{const e=v.value,s=e.length>=8,t=/\d/.test(e),o=/[!@#$%^&*]/.test(e);te.textContent=`Length: ${e.length} (${s?"✓":"✘"}), Digit: ${t?"✓":"✘"}, Special: ${o?"✓":"✘"}`});const D=document.getElementById("auth-user"),M=document.getElementById("auth-guest"),oe=document.getElementById("logout-btn"),se=document.getElementById("user-greeting");if(!D||!M||!oe||!se)throw new Error("Missing auth containers");function L(){localStorage.getItem("loggedIn")==="true"?(D.classList.remove("hidden"),M.classList.add("hidden"),se.textContent=localStorage.getItem("username")||"Player"):(D.classList.add("hidden"),M.classList.remove("hidden"))}oe.addEventListener("click",e=>{e.preventDefault(),localStorage.removeItem("loggedIn"),localStorage.removeItem("username"),L()});L();z.addEventListener("click",e=>{e.preventDefault(),r.classList.remove("hidden")});X.addEventListener("click",e=>{e.preventDefault(),r.classList.add("hidden")});Y.addEventListener("click",e=>{e.preventDefault(),r.classList.add("hidden")});document.addEventListener("keydown",e=>{e.key==="Escape"&&r&&!r.classList.contains("hidden")&&r.classList.add("hidden")});r.addEventListener("click",e=>{e.target===r&&r.classList.add("hidden")});Q.addEventListener("submit",async e=>{e.preventDefault();const s=Z.value,t=ee.value,o=v.value,n=ne.value,l=o.length>=8,c=/\d/.test(o),f=/[!@#$%^&*]/.test(o);if(!l||!c||!f){alert("Password must be at least 8 characters and include a number and special character.");return}if(o!==n){alert("Passwords do not match");return}try{const u=await fetch("/api/auth/signup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,name:t,password:o})}),B=await u.json();u.ok?(localStorage.setItem("loggedIn","true"),localStorage.setItem("username",t),L(),r.classList.add("hidden")):alert(B.error||"Sign up failed")}catch(u){console.error("Signup error:",u),alert("Sign up error")}});x.addEventListener("click",()=>{var s;if(g.classList.toggle("hidden"),!g.classList.contains("hidden"))return;const e=g.value;(s=d.requestFullscreen)==null||s.call(d).catch(()=>{}),j(()=>G("ai",e))});C.addEventListener("click",()=>{var e;g.classList.add("hidden"),(e=d.requestFullscreen)==null||e.call(d).catch(()=>{}),j(()=>G("pvp"))});A.addEventListener("click",()=>{var e;g.classList.add("hidden"),(e=d.requestFullscreen)==null||e.call(d).catch(()=>{}),j(()=>G("tournament"))});
